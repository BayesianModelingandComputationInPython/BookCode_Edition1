
<!DOCTYPE html>

<html data-content_root="" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Code 4: Extending Linear Models — Bayesian Modeling and Computation in Python</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet"/>
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" rel="stylesheet" type="text/css"/>
<link href="../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css"/>
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx-codeautolink.css" rel="stylesheet" type="text/css"/>
<link href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" rel="preload"/>
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" rel="preload"/>
<script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../_static/togglebutton.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script src="../_static/design-tabs.js"></script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
<script async="async" src="../_static/sphinx-thebe.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/chp_04';</script>
<link href="../_static/favicon.ico" rel="shortcut icon"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="chp_05.html" rel="next" title="Code 5: Splines"/>
<link href="chp_03.html" rel="prev" title="Code 3: Linear Models and Probabilistic Programming Languages"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<a class="skip-link" href="#main-content">Skip to main content</a>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>
<input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
<label class="overlay overlay-primary" for="__primary"></label>
<input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
<label class="overlay overlay-secondary" for="__secondary"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<nav class="bd-header navbar navbar-expand-lg bd-navbar">
</nav>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
</div>
<div class="sidebar-primary-items__start sidebar-primary__section">
<div class="sidebar-primary-item">
<a class="navbar-brand logo" href="../welcome.html">
<p class="title logo__title">Bayesian Modeling and Computation in Python</p>
</a></div>
<div class="sidebar-primary-item"><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 0</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../markdown/dedication.html">Dedication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/foreword.html">Foreword</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/symbollist.html">Symbols</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 1</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_01.html">1. Bayesian Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_02.html">2. Exploratory Analysis of Bayesian Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_03.html">3. Linear Models and Probabilistic Programming Languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_04.html">4. Extending Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_05.html">5. Splines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_06.html">6. Time Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_07.html">7. Bayesian Additive Regression Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_08.html">8. Approximate Bayesian Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_09.html">9. End to End Bayesian Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_10.html">10. Probabilistic Programming Languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/chp_11.html">11. Appendiceal Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/glossary.html">12. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/references.html">13. References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 2</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chp_01.html">Code 1: Bayesian Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_02.html">Code 2: Exploratory Analysis of Bayesian Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_03.html">Code 3: Linear Models and Probabilistic Programming Languages</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Code 4: Extending Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_05.html">Code 5: Splines</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_06.html">Code 6: Time Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_07.html">Code 7: Bayesian Additive Regression Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_08.html">Code 8: Approximate Bayesian Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_09.html">Code 9: End to End Bayesian Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_10.html">Code 10: Probabilistic Programming Languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="chp_11.html">Code 11: Appendiceal Topics</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../solutions/chp_01.html">Solutions 1: Bayesian Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../solutions/chp_02.html">Solutions 2: Exploratory Analysis of Bayesian models</a></li>
</ul>
</div>
</nav></div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</label></div>
</div>
<div class="header-article-items__end">
<div class="header-article-item">
<div class="article-header-buttons">
<div class="dropdown dropdown-source-buttons">
<button aria-expanded="false" aria-label="Source repositories" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fab fa-github"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm btn-source-repository-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/BayesianModelingandComputationInPython/BookCode_Edition1" target="_blank" title="Source repository">
<span class="btn__icon-container">
<i class="fab fa-github"></i>
</span>
<span class="btn__text-container">Repository</span>
</a>
</li>
<li><a class="btn btn-sm btn-source-issues-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/BayesianModelingandComputationInPython/BookCode_Edition1/issues/new?title=Issue%20on%20page%20%2Fnotebooks/chp_04.html&amp;body=Your%20issue%20content%20here." target="_blank" title="Open an issue">
<span class="btn__icon-container">
<i class="fas fa-lightbulb"></i>
</span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
</ul>
</div>
<button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="btn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</label>
</div></div>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>Code 4: Extending Linear Models</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transforming-covariates">Transforming Covariates</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-1">Code 4.1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-1">Figure 4.1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-2">Code 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-2">Figure 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-3">Code 4.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-3">Figure 4.3</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#varying-uncertainty">Varying Uncertainty</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-4">Code 4.4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-4">Figure 4.4</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interaction-effects">Interaction effects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-5">Code 4.5</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-6">Code 4.6</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-5">Figure 4.5</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#robust-regression">Robust Regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-6">Figure 4.6</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-7">Figure 4.7</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-7">Code 4.7</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-8">Figure 4.8</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-1">Table 4.1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-2">Table 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-9">Figure 4.9</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-multilevel-models-and-mixed-effects">Pooling, Multilevel Models, and Mixed Effects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-10">Figure 4.10</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unpooled-model">Unpooled Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-9">Code 4.9</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-12">Figure 4.12</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-13">Figure 4.13</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-14">Figure 4.14</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooled-model">Pooled Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-10">Code 4.10</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-16">Figure 4.16</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-17">Figure 4.17</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-18">Figure 4.18</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-11">Code 4.11</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-20">Figure 4.20</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-21">Figure 4.21</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hierarchical">Hierarchical</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-12">Code 4.12</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-23">Figure 4.23</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-3">Table 4.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-4">Table 4.4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-25">Figure 4.25</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-26">Figure 4.26</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-13">Code 4.13</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-14-and-4-15">Code 4.14 and 4.15</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-27">Figure 4.27</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-16">Code 4.16</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-28">Figure  4.28</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-29">Figure 4.29</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-17">Code 4.17</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-18">Code 4.18</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article" role="main">
<section class="tex2jax_ignore mathjax_ignore" id="code-4-extending-linear-models">
<h1>Code 4: Extending Linear Models<a class="headerlink" href="#code-4-extending-linear-models" title="Permalink to this heading">#</a></h1>
<div class="tip dropdown admonition">
<p class="admonition-title">This is a reference notebook for the book Bayesian Modeling and Computation in Python</p>
<p>The textbook is not needed to use or run this code, though the context and explanation is missing from this notebook.</p>
<p>If you’d like a copy it’s available
<a class="reference external" href="https://www.routledge.com/Bayesian-Modeling-and-Computation-in-Python/Martin-Kumar-Lao/p/book/9780367894368">from the CRC Press</a>
or from <a class="reference external" href="https://www.routledge.com/Bayesian-Modeling-and-Computation-in-Python/Martin-Kumar-Lao/p/book/9780367894368">Amazon</a>.
``</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/pyplot_summary.html#module-matplotlib.pyplot" title="matplotlib.pyplot"><span class="nn">matplotlib.pyplot</span></a> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="numpy"><span class="nn">numpy</span></a> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/index.html#module-scipy" title="scipy"><span class="nn">scipy</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/stats.html#module-scipy.stats" title="scipy.stats"><span class="n">stats</span></a>

<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">tt</span>
<span class="kn">import</span> <span class="nn">theano</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Last Run </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last Run 2021-11-19 16:44:33.955392
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">"arviz-grayscale"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.dpi'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span> 
</pre></div>
</div>
</div>
</div>
<section id="transforming-covariates">
<h2>Transforming Covariates<a class="headerlink" href="#transforming-covariates" title="Permalink to this heading">#</a></h2>
<section id="code-4-1">
<h3>Code 4.1<a class="headerlink" href="#code-4-1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">babies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/babies.csv'</span><span class="p">)</span>

<span class="c1"># Add a constant term so we can use a the dot product approach</span>
<span class="n">babies</span><span class="p">[</span><span class="s2">"Intercept"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">babies</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Month</th>
<th>Length</th>
<th>Intercept</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>0</td>
<td>48.5</td>
<td>1</td>
</tr>
<tr>
<th>1</th>
<td>0</td>
<td>50.5</td>
<td>1</td>
</tr>
<tr>
<th>2</th>
<td>0</td>
<td>50.5</td>
<td>1</td>
</tr>
<tr>
<th>3</th>
<td>0</td>
<td>52.0</td>
<td>1</td>
</tr>
<tr>
<th>4</th>
<td>0</td>
<td>47.5</td>
<td>1</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
<section id="figure-4-1">
<h3>Figure 4.1<a class="headerlink" href="#figure-4-1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">],</span> <span class="s1">'C0.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Length"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">);</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/baby_length_scatter.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e1457a310fb2286e4a0e3b13e62b5bb5c8f0627bae35c3a4cebe45753e539972.png" src="../_images/e1457a310fb2286e4a0e3b13e62b5bb5c8f0627bae35c3a4cebe45753e539972.png"/>
</div>
</div>
</section>
<section id="code-4-2">
<h3>Code 4.2<a class="headerlink" href="#code-4-2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_baby_linear</span><span class="p">:</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">'β'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Use dot product instead of expanded multiplication</span>
    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">babies</span><span class="p">[[</span><span class="s2">"Intercept"</span><span class="p">,</span> <span class="s2">"Month"</span><span class="p">]],</span> <span class="n">β</span><span class="p">))</span>
    <span class="n">ϵ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"ϵ"</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">length</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"length"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">ϵ</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">])</span>

    <span class="n">trace_linear</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>
    <span class="n">pcc_linear</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">trace_linear</span><span class="p">)</span>
    <span class="n">inf_data_linear</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">trace_linear</span><span class="p">,</span>
                                    <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">pcc_linear</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/2954483905.py:10: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_linear = pm.sample(draws=2000, tune=4000)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [ϵ, β]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="24000" style="width:300px; height:20px; vertical-align: middle;" value="24000"></progress>
      100.00% [24000/24000 00:08&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 4_000 tune and 2_000 draw iterations (16_000 + 8_000 draws total) took 18 seconds.
The acceptance probability does not match the target. It is 0.5738214538580835, but should be close to 0.8. Try to increase the number of tuning steps.
The acceptance probability does not match the target. It is 0.8837497551468421, but should be close to 0.8. Try to increase the number of tuning steps.
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:06&lt;00:00]
    </div>
</div></div>
</div>
</section>
<section id="figure-4-2">
<h3>Figure 4.2<a class="headerlink" href="#figure-4-2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Length"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">);</span>

<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_linear</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_linear</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_linear</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.94</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">],</span> <span class="s1">'C0.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/baby_length_linear_fit.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5f9faf04dea74a256155450ed9b726f6974439ae77621b0c7b846168bc23242c.png" src="../_images/5f9faf04dea74a256155450ed9b726f6974439ae77621b0c7b846168bc23242c.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.loo.html#arviz.loo" title="arviz.loo"><span class="n">az</span><span class="o">.</span><span class="n">loo</span></a><span class="p">(</span><span class="n">inf_data_linear</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed from 8000 by 800 log-likelihood matrix

         Estimate       SE
elpd_loo -2133.32    18.59
p_loo        3.23        -
</pre></div>
</div>
</div>
</div>
</section>
<section id="code-4-3">
<h3>Code 4.3<a class="headerlink" href="#code-4-3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_baby_sqrt</span><span class="p">:</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">β</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">]))</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">length</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"length"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">])</span>
    <span class="n">inf_data_sqrt</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>

    <span class="n">ppc_baby_sqrt</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">inf_data_sqrt</span><span class="p">)</span>
    <span class="n">inf_data_sqrt</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">inf_data_sqrt</span><span class="p">,</span>
                                  <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc_baby_sqrt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/628193978.py:8: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  inf_data_sqrt = pm.sample(draws=2000, tune=4000)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="24000" style="width:300px; height:20px; vertical-align: middle;" value="24000"></progress>
      100.00% [24000/24000 00:10&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 4_000 tune and 2_000 draw iterations (16_000 + 8_000 draws total) took 19 seconds.
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:06&lt;00:00]
    </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">],</span> <span class="s1">'C0.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Length"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">);</span>

<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.94</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/baby_length_sqrt_fit.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06b95f40cd4148511e7bd6931a46efe83f339e56ded5bd4b896c23bbb821b6d0.png" src="../_images/06b95f40cd4148511e7bd6931a46efe83f339e56ded5bd4b896c23bbb821b6d0.png"/>
</div>
</div>
</section>
<section id="figure-4-3">
<h3>Figure 4.3<a class="headerlink" href="#figure-4-3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">],</span> <span class="s1">'C0.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.94</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Length"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">);</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">]),</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">],</span> <span class="s1">'C0.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Square Root of Month"</span><span class="p">);</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">]),</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">]),</span> <span class="n">inf_data_sqrt</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.94</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">]),</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/baby_length_sqrt_fit.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3bf323a35470d502a0a28682005680643c12bd25cdb5f4a0169dc545953afb31.png" src="../_images/3bf323a35470d502a0a28682005680643c12bd25cdb5f4a0169dc545953afb31.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.compare.html#arviz.compare" title="arviz.compare"><span class="n">az</span><span class="o">.</span><span class="n">compare</span></a><span class="p">({</span><span class="s2">"Linear Model"</span><span class="p">:</span><span class="n">inf_data_linear</span><span class="p">,</span> <span class="s2">"Non Linear Model"</span><span class="p">:</span><span class="n">inf_data_sqrt</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/stats/stats.py:145: UserWarning: The default method used to estimate the weights for each model,has changed from BB-pseudo-BMA to stacking
  warnings.warn(
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>rank</th>
<th>loo</th>
<th>p_loo</th>
<th>d_loo</th>
<th>weight</th>
<th>se</th>
<th>dse</th>
<th>warning</th>
<th>loo_scale</th>
</tr>
</thead>
<tbody>
<tr>
<th>Non Linear Model</th>
<td>0</td>
<td>-1968.218405</td>
<td>3.079101</td>
<td>0.000000</td>
<td>0.928708</td>
<td>18.990940</td>
<td>0.000000</td>
<td>False</td>
<td>log</td>
</tr>
<tr>
<th>Linear Model</th>
<td>1</td>
<td>-2133.321593</td>
<td>3.229639</td>
<td>165.103188</td>
<td>0.071292</td>
<td>18.589207</td>
<td>20.083518</td>
<td>False</td>
<td>log</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="varying-uncertainty">
<h2>Varying Uncertainty<a class="headerlink" href="#varying-uncertainty" title="Permalink to this heading">#</a></h2>
<section id="code-4-4">
<h3>Code 4.4<a class="headerlink" href="#code-4-4" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_baby_vv</span><span class="p">:</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Additional variance terms</span>
    <span class="n">δ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"δ"</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">β</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">]))</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="n">δ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">δ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">])</span>

    <span class="n">length</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"length"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">])</span>

    <span class="n">trace_baby_vv</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">.95</span><span class="p">)</span>
    <span class="n">ppc_baby_vv</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">trace_baby_vv</span><span class="p">,</span>
                                                 <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"length"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">])</span>
    <span class="n">inf_data_baby_vv</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">trace_baby_vv</span><span class="p">,</span>
                                     <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc_baby_vv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/3065721124.py:12: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_baby_vv = pm.sample(2000, target_accept=.95)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [δ, β]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="12000" style="width:300px; height:20px; vertical-align: middle;" value="12000"></progress>
      100.00% [12000/12000 00:09&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 2_000 draw iterations (4_000 + 8_000 draws total) took 19 seconds.
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:08&lt;00:00]
    </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_baby_vv</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"δ"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr>
<th>δ[0]</th>
<td>2.389</td>
<td>0.117</td>
<td>2.17</td>
<td>2.609</td>
<td>0.002</td>
<td>0.002</td>
<td>2715.0</td>
<td>2919.0</td>
<td>1.0</td>
</tr>
<tr>
<th>δ[1]</th>
<td>0.038</td>
<td>0.009</td>
<td>0.02</td>
<td>0.056</td>
<td>0.000</td>
<td>0.000</td>
<td>2663.0</td>
<td>2329.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Length"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">],</span> <span class="s1">'C0.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_baby_vv</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_baby_vv</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_baby_vv</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.94</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/baby_length_sqrt_vv_fit.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/01874093ba1a8781efdf3f5cd41b7b2b6ba315f536a1bf26ef2118a629726a47.png" src="../_images/01874093ba1a8781efdf3f5cd41b7b2b6ba315f536a1bf26ef2118a629726a47.png"/>
</div>
</div>
</section>
<section id="figure-4-4">
<h3>Figure 4.4<a class="headerlink" href="#figure-4-4" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">],</span> <span class="s1">'C0.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_baby_vv</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">babies</span><span class="p">[</span><span class="s2">"Length"</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_baby_vv</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">inf_data_baby_vv</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"length"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.94</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Length"</span><span class="p">)</span>

<span class="n">σ_m</span> <span class="o">=</span> <span class="n">inf_data_baby_vv</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">babies</span><span class="p">[</span><span class="s2">"Month"</span><span class="p">],</span> <span class="n">σ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C1'</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/baby_length_sqrt_vv_fit_include_error.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e9722b4a4e660679c803b7c3d56471105af0cab0d0698be9f3d786adeba678e1.png" src="../_images/e9722b4a4e660679c803b7c3d56471105af0cab0d0698be9f3d786adeba678e1.png"/>
</div>
</div>
</section>
</section>
<section id="interaction-effects">
<h2>Interaction effects<a class="headerlink" href="#interaction-effects" title="Permalink to this heading">#</a></h2>
<section id="code-4-5">
<h3>Code 4.5<a class="headerlink" href="#code-4-5" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tips_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/tips.csv'</span><span class="p">)</span>
<span class="n">tips_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>total_bill</th>
<th>tip</th>
<th>sex</th>
<th>smoker</th>
<th>day</th>
<th>time</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>16.99</td>
<td>1.01</td>
<td>Female</td>
<td>No</td>
<td>Sun</td>
<td>Dinner</td>
<td>2</td>
</tr>
<tr>
<th>1</th>
<td>10.34</td>
<td>1.66</td>
<td>Male</td>
<td>No</td>
<td>Sun</td>
<td>Dinner</td>
<td>3</td>
</tr>
<tr>
<th>2</th>
<td>21.01</td>
<td>3.50</td>
<td>Male</td>
<td>No</td>
<td>Sun</td>
<td>Dinner</td>
<td>3</td>
</tr>
<tr>
<th>3</th>
<td>23.68</td>
<td>3.31</td>
<td>Male</td>
<td>No</td>
<td>Sun</td>
<td>Dinner</td>
<td>2</td>
</tr>
<tr>
<th>4</th>
<td>24.59</td>
<td>3.61</td>
<td>Female</td>
<td>No</td>
<td>Sun</td>
<td>Dinner</td>
<td>4</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tips</span> <span class="o">=</span> <span class="n">tips_df</span><span class="p">[</span><span class="s2">"tip"</span><span class="p">]</span>
<span class="n">total_bill_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">tips_df</span><span class="p">[</span><span class="s2">"total_bill"</span><span class="p">]</span> <span class="o">-</span> <span class="n">tips_df</span><span class="p">[</span><span class="s2">"total_bill"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>  
<span class="n">smoker</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">tips_df</span><span class="p">[</span><span class="s2">"smoker"</span><span class="p">])</span><span class="o">.</span><span class="n">codes</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_no_interaction</span><span class="p">:</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">μ</span> <span class="o">=</span> <span class="p">(</span><span class="n">β</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
         <span class="n">β</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_bill_c</span> <span class="o">+</span> 
         <span class="n">β</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">smoker</span><span class="p">)</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"obs"</span><span class="p">,</span> <span class="n">μ</span><span class="p">,</span> <span class="n">σ</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">tips</span><span class="p">)</span>
    <span class="n">trace_no_interaction</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/3786948218.py:14: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_no_interaction = pm.sample(1000, tune=1000)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:03&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 13 seconds.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">))</span>

<span class="n">β0_nonint</span> <span class="o">=</span> <span class="n">trace_no_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">β1_nonint</span> <span class="o">=</span> <span class="n">trace_no_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">β2_nonint</span> <span class="o">=</span> <span class="n">trace_no_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span>

<span class="n">pred_y_non_smokers</span> <span class="o">=</span> <span class="n">β0_nonint</span> <span class="o">+</span> <span class="n">β1_nonint</span> <span class="o">*</span> <span class="n">total_bill_c</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
<span class="n">pred_y_smokers</span> <span class="o">=</span> <span class="n">β0_nonint</span> <span class="o">+</span> <span class="n">β1_nonint</span> <span class="o">*</span> <span class="n">total_bill_c</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">β2_nonint</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span> <span class="n">tips</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'non-smokers'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">tips</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'smokers'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Total Bill'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Tip'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_non_smokers</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_smokers</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/2436504886.py:7: FutureWarning: Support for multi-dimensional indexing (e.g. `obj[:, None]`) is deprecated and will be removed in a future version.  Convert to a numpy array before indexing instead.
  pred_y_non_smokers = β0_nonint + β1_nonint * total_bill_c[:,None]
/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/2436504886.py:8: FutureWarning: Support for multi-dimensional indexing (e.g. `obj[:, None]`) is deprecated and will be removed in a future version.  Convert to a numpy array before indexing instead.
  pred_y_smokers = β0_nonint + β1_nonint * total_bill_c[:,None] + β2_nonint
</pre></div>
</div>
<img alt="../_images/17e5163bbbe08d1c9773c196b80d11a0d248a2f955beca9e50144b728b2a0256.png" src="../_images/17e5163bbbe08d1c9773c196b80d11a0d248a2f955beca9e50144b728b2a0256.png"/>
</div>
</div>
</section>
<section id="code-4-6">
<h3>Code 4.6<a class="headerlink" href="#code-4-6" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_interaction</span><span class="p">:</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">'β'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s1">'σ'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">μ</span> <span class="o">=</span> <span class="p">(</span><span class="n">β</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
         <span class="n">β</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_bill_c</span> <span class="o">+</span> 
         <span class="n">β</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">smoker</span> <span class="o">+</span>
         <span class="n">β</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">smoker</span> <span class="o">*</span> <span class="n">total_bill_c</span>
        <span class="p">)</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">'obs'</span><span class="p">,</span> <span class="n">μ</span><span class="p">,</span> <span class="n">σ</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">tips</span><span class="p">)</span>
    <span class="n">trace_interaction</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/146995100.py:12: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_interaction = pm.sample(1000, tune=1000)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [σ, β]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:04&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 13 seconds.
</pre></div>
</div>
</div>
</div>
</section>
<section id="figure-4-5">
<h3>Figure 4.5<a class="headerlink" href="#figure-4-5" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_bill_c</span> <span class="o">=</span> <span class="n">total_bill_c</span><span class="o">.</span><span class="n">values</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">))</span>

<span class="c1">#α_nonint = trace_nonint['α']</span>

<span class="n">β0_nonint</span> <span class="o">=</span> <span class="n">trace_no_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">β1_nonint</span> <span class="o">=</span> <span class="n">trace_no_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">β2_nonint</span> <span class="o">=</span> <span class="n">trace_no_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span>


<span class="n">pred_y_non_smokers</span> <span class="o">=</span> <span class="n">β0_nonint</span> <span class="o">+</span> <span class="n">β1_nonint</span> <span class="o">*</span> <span class="n">total_bill_c</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
<span class="n">pred_y_smokers</span> <span class="o">=</span> <span class="n">β0_nonint</span> <span class="o">+</span> <span class="n">β1_nonint</span> <span class="o">*</span> <span class="n">total_bill_c</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">β2_nonint</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span> <span class="n">tips</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'non-smokers'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">tips</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'smokers'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Total Bill (Centered)'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Tip'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_non_smokers</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_smokers</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'No Interaction'</span><span class="p">)</span>


<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_non_smokers</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'C0'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_smokers</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">);</span>

<span class="n">β0_int</span> <span class="o">=</span> <span class="n">trace_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">β1_int</span> <span class="o">=</span> <span class="n">trace_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">β2_int</span> <span class="o">=</span> <span class="n">trace_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">β3_int</span> <span class="o">=</span> <span class="n">trace_interaction</span><span class="p">[</span><span class="s1">'β'</span><span class="p">][:,</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># Because smoker=0 I am ommiting the terms including the smoker covariate</span>
<span class="n">pred_y_non_smokers</span> <span class="o">=</span> <span class="p">(</span><span class="n">β0_int</span> <span class="o">+</span>
                      <span class="n">β1_int</span> <span class="o">*</span> <span class="n">total_bill_c</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

<span class="c1"># Because x1=1 I am ommiting x1</span>
<span class="n">pred_y_smokers</span> <span class="o">=</span> <span class="p">(</span><span class="n">β0_int</span> <span class="o">+</span>
                  <span class="n">β1_int</span> <span class="o">*</span> <span class="n">total_bill_c</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">β2_int</span> <span class="o">+</span>
                  <span class="n">β3_int</span> <span class="o">*</span> <span class="n">total_bill_c</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>


<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span> <span class="n">tips</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'non-smokers'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">tips</span><span class="p">[</span><span class="n">smoker</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'smokers'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Total Bill (Centered)'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Interaction'</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_non_smokers</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_smokers</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_non_smokers</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'C0'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">total_bill_c</span><span class="p">,</span> <span class="n">pred_y_smokers</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">);</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/smoker_tip_interaction.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/stats/stats.py:456: FutureWarning: hdi currently interprets 2d data as (draw, shape) but this will change in a future release to (chain, draw) for coherence with other functions
  warnings.warn(
/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/stats/stats.py:456: FutureWarning: hdi currently interprets 2d data as (draw, shape) but this will change in a future release to (chain, draw) for coherence with other functions
  warnings.warn(
/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/stats/stats.py:456: FutureWarning: hdi currently interprets 2d data as (draw, shape) but this will change in a future release to (chain, draw) for coherence with other functions
  warnings.warn(
/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/stats/stats.py:456: FutureWarning: hdi currently interprets 2d data as (draw, shape) but this will change in a future release to (chain, draw) for coherence with other functions
  warnings.warn(
</pre></div>
</div>
<img alt="../_images/eabd52505ca5cf79c32689961c628fb140d4ed89c9eaf11d6031145d6a5f7a94.png" src="../_images/eabd52505ca5cf79c32689961c628fb140d4ed89c9eaf11d6031145d6a5f7a94.png"/>
</div>
</div>
</section>
</section>
<section id="robust-regression">
<h2>Robust Regression<a class="headerlink" href="#robust-regression" title="Permalink to this heading">#</a></h2>
<section id="figure-4-6">
<h3>Figure 4.6<a class="headerlink" href="#figure-4-6" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">x</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.linspace.html#numpy.linspace" title="numpy.linspace"><span class="n">np</span><span class="o">.</span><span class="n">linspace</span></a><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.norm.html#scipy.stats.norm" title="scipy.stats.norm"><span class="n">stats</span><span class="o">.</span><span class="n">norm</span></a><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Normal μ=</span><span class="si">{</span><span class="n">mean</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.t.html#scipy.stats.t" title="scipy.stats.t"><span class="n">stats</span><span class="o">.</span><span class="n">t</span></a><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Student T μ=</span><span class="si">{</span><span class="n">mean</span><span class="si">}</span><span class="s2">, σ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s2">, ν=</span><span class="si">{</span><span class="n">nu</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">"C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/studentt_normal_comparison.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/248e8d6fadddf823df8a764495b525362fa762411345c41ea9897cafaf4aafa7.png" src="../_images/248e8d6fadddf823df8a764495b525362fa762411345c41ea9897cafaf4aafa7.png"/>
</div>
</div>
</section>
<section id="figure-4-7">
<h3>Figure 4.7<a class="headerlink" href="#figure-4-7" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_sales</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.seed.html#numpy.random.seed" title="numpy.random.seed"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span></a><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"customers"</span><span class="p">,</span> <span class="s2">"sales"</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">num_customers</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.randint.html#scipy.stats.randint" title="scipy.stats.randint"><span class="n">stats</span><span class="o">.</span><span class="n">randint</span></a><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="c1"># This is correct as there is an independent draw for each customers orders</span>
        <span class="n">dollar_sales</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.norm.html#scipy.stats.norm" title="scipy.stats.norm"><span class="n">stats</span><span class="o">.</span><span class="n">norm</span></a><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">num_customers</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">day</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_customers</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">day</span><span class="p">,</span> <span class="s2">"sales"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dollar_sales</span>
        
    <span class="c1"># Fix the types as not to cause Theano errors</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">'customers'</span><span class="p">:</span> <span class="s1">'int32'</span><span class="p">,</span> <span class="s1">'sales'</span><span class="p">:</span> <span class="s1">'float32'</span><span class="p">})</span>
    
    <span class="c1"># Sorting will make plotting the posterior predictive easier later</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"Food_Category"</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"customers"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>

<span class="n">empanadas</span> <span class="o">=</span>  <span class="n">generate_sales</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Empanada"</span><span class="p">)</span>
<span class="n">empanadas</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">92000</span><span class="p">,</span> <span class="s2">"Empanada"</span><span class="p">]</span>
<span class="n">empanadas</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">90000</span><span class="p">,</span> <span class="s2">"Empanada"</span><span class="p">]</span>
<span class="n">empanadas</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">70</span><span class="p">,</span> <span class="mi">96000</span><span class="p">,</span> <span class="s2">"Empanada"</span><span class="p">]</span>
<span class="n">empanadas</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">91000</span><span class="p">,</span> <span class="s2">"Empanada"</span><span class="p">]</span>
<span class="n">empanadas</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">99000</span><span class="p">,</span> <span class="s2">"Empanada"</span><span class="p">]</span>

<span class="n">empanadas</span> <span class="o">=</span> <span class="n">empanadas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"customers"</span><span class="p">)</span>

<span class="n">empanadas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>
<span class="n">empanadas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Argentine Peso"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Customer Count"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Empanada Sales"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/empanada_scatter_plot.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9319f512c99bfd1c3fc71c13c49953f4e459fa09afa768d67c69d542ee75d977.png" src="../_images/9319f512c99bfd1c3fc71c13c49953f4e459fa09afa768d67c69d542ee75d977.png"/>
</div>
</div>
</section>
<section id="code-4-7">
<h3>Code 4.7<a class="headerlink" href="#code-4-7" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_non_robust</span><span class="p">:</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">'β'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span> <span class="o">*</span> <span class="n">empanadas</span><span class="p">[</span><span class="s2">"customers"</span><span class="p">])</span>
    
    <span class="n">sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">empanadas</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">])</span>
    
    <span class="n">trace_empanada_sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ppc_empanada_sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span>
        <span class="n">trace_empanada_sales</span><span class="p">)</span>
    <span class="n">inf_data_non_robust</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace_empanada_sales</span><span class="p">,</span>
                                        <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc_empanada_sales</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/1588961933.py:9: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_empanada_sales = pm.sample(random_seed=1)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [β, σ]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:07&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 16 seconds.
The acceptance probability does not match the target. It is 0.8860777877942666, but should be close to 0.8. Try to increase the number of tuning steps.
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="4000" style="width:300px; height:20px; vertical-align: middle;" value="4000"></progress>
      100.00% [4000/4000 00:03&lt;00:00]
    </div>
</div></div>
</div>
</section>
<section id="figure-4-8">
<h3>Figure 4.8<a class="headerlink" href="#figure-4-8" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_non_robust</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">empanadas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">empanadas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">empanadas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">empanadas</span><span class="o">.</span><span class="n">customers</span><span class="p">,</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>
    <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">empanadas</span><span class="o">.</span><span class="n">customers</span><span class="p">,</span> <span class="n">inf_data_non_robust</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.95</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Argentine Peso"</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Customer Count"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">25000</span><span class="p">);</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/empanada_scatter_non_robust.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a6576c0ec6edce5ba4b663a2a7fd064f73c1466e2e6af64850916aefa4f06532.png" src="../_images/a6576c0ec6edce5ba4b663a2a7fd064f73c1466e2e6af64850916aefa4f06532.png"/>
</div>
</div>
</section>
<section id="table-4-1">
<h3>Table 4.1<a class="headerlink" href="#table-4-1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_non_robust</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"stats"</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
</tr>
</thead>
<tbody>
<tr>
<th>β</th>
<td>207.0</td>
<td>3.0</td>
<td>201.4</td>
<td>212.5</td>
</tr>
<tr>
<th>σ</th>
<td>2952.3</td>
<td>25.3</td>
<td>2904.3</td>
<td>2997.6</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_robust</span><span class="p">:</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ν</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"ν"</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span> <span class="o">*</span> <span class="n">empanadas</span><span class="p">[</span><span class="s2">"customers"</span><span class="p">])</span>
    
    <span class="n">sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="n">ν</span><span class="p">,</span>
                        <span class="n">observed</span><span class="o">=</span><span class="n">empanadas</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">])</span>
        
    <span class="n">trace_empanada_sales_robust</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ppc_empanada_sales_robust</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span>
                                        <span class="n">trace_empanada_sales_robust</span><span class="p">)</span>
    
    <span class="n">inf_data_robust</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace_empanada_sales_robust</span><span class="p">,</span>
                                    <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc_empanada_sales_robust</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/2239246076.py:11: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_empanada_sales_robust = pm.sample(random_seed=0)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [ν, β, σ]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:03&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 12 seconds.
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="4000" style="width:300px; height:20px; vertical-align: middle;" value="4000"></progress>
      100.00% [4000/4000 00:02&lt;00:00]
    </div>
</div></div>
</div>
</section>
<section id="table-4-2">
<h3>Table 4.2<a class="headerlink" href="#table-4-2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_robust</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">,</span> <span class="s2">"ν"</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"stats"</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
</tr>
</thead>
<tbody>
<tr>
<th>β</th>
<td>179.6</td>
<td>0.3</td>
<td>179.1</td>
<td>180.1</td>
</tr>
<tr>
<th>σ</th>
<td>152.0</td>
<td>13.9</td>
<td>126.4</td>
<td>178.4</td>
</tr>
<tr>
<th>ν</th>
<td>1.3</td>
<td>0.2</td>
<td>1.0</td>
<td>1.6</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
<section id="figure-4-9">
<h3>Figure 4.9<a class="headerlink" href="#figure-4-9" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_robust</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">empanadas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">empanadas</span><span class="o">.</span><span class="n">customers</span><span class="p">,</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">empanadas</span><span class="o">.</span><span class="n">customers</span><span class="p">,</span> <span class="n">inf_data_robust</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.95</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">empanadas</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Argentine Peso"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Customer Count"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Empanada Sales with Robust Regression Fit"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/empanada_scatter_robust.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/388f2084cea358bdb3aab1d16f5298266f6bc2f7c0fec8bcb5290ae3102f1f91.png" src="../_images/388f2084cea358bdb3aab1d16f5298266f6bc2f7c0fec8bcb5290ae3102f1f91.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.compare.html#arviz.compare" title="arviz.compare"><span class="n">az</span><span class="o">.</span><span class="n">compare</span></a><span class="p">({</span><span class="s2">"Non robust"</span><span class="p">:</span> <span class="n">inf_data_non_robust</span><span class="p">,</span> <span class="s2">"Robust"</span><span class="p">:</span><span class="n">inf_data_robust</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/stats/stats.py:145: UserWarning: The default method used to estimate the weights for each model,has changed from BB-pseudo-BMA to stacking
  warnings.warn(
/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/stats/stats.py:655: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  warnings.warn(
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>rank</th>
<th>loo</th>
<th>p_loo</th>
<th>d_loo</th>
<th>weight</th>
<th>se</th>
<th>dse</th>
<th>warning</th>
<th>loo_scale</th>
</tr>
</thead>
<tbody>
<tr>
<th>Robust</th>
<td>0</td>
<td>-1473.978565</td>
<td>5.912134</td>
<td>0.000000</td>
<td>1.000000e+00</td>
<td>31.902351</td>
<td>0.000000</td>
<td>False</td>
<td>log</td>
</tr>
<tr>
<th>Non robust</th>
<td>1</td>
<td>-3698.588569</td>
<td>146.177400</td>
<td>2224.610004</td>
<td>1.146134e-09</td>
<td>829.237992</td>
<td>799.490297</td>
<td>True</td>
<td>log</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="pooling-multilevel-models-and-mixed-effects">
<h2>Pooling, Multilevel Models, and Mixed Effects<a class="headerlink" href="#pooling-multilevel-models-and-mixed-effects" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_sales</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.seed.html#numpy.random.seed" title="numpy.random.seed"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span></a><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"customers"</span><span class="p">,</span> <span class="s2">"sales"</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">num_customers</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.randint.html#scipy.stats.randint" title="scipy.stats.randint"><span class="n">stats</span><span class="o">.</span><span class="n">randint</span></a><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="c1"># This is correct as there is an independent draw for each customers orders</span>
        <span class="n">dollar_sales</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.norm.html#scipy.stats.norm" title="scipy.stats.norm"><span class="n">stats</span><span class="o">.</span><span class="n">norm</span></a><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">num_customers</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">day</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_customers</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">day</span><span class="p">,</span> <span class="s2">"sales"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dollar_sales</span>
        
    <span class="c1"># Fix the types as not to cause Theano errors</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">'customers'</span><span class="p">:</span> <span class="s1">'int32'</span><span class="p">,</span> <span class="s1">'sales'</span><span class="p">:</span> <span class="s1">'float32'</span><span class="p">})</span>
    
    <span class="c1"># Sorting will make plotting the posterior predictive easier later</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"Food_Category"</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"customers"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pizza_df</span> <span class="o">=</span> <span class="n">generate_sales</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Pizza"</span><span class="p">)</span>
<span class="n">sandwich_df</span> <span class="o">=</span> <span class="n">generate_sales</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Sandwich"</span><span class="p">)</span>

<span class="n">salad_days</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">salad_df</span> <span class="o">=</span> <span class="n">generate_sales</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">salad_days</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">8</span> <span class="p">,</span><span class="n">std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Salad"</span><span class="p">)</span>

<span class="n">salad_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d57080a81eead43317b362173c174ecb769e5a75f44b12d04a5f933fb05944c3.png" src="../_images/d57080a81eead43317b362173c174ecb769e5a75f44b12d04a5f933fb05944c3.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sales_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pizza_df</span><span class="p">,</span> <span class="n">sandwich_df</span><span class="p">,</span> <span class="n">salad_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sales_df</span><span class="p">[</span><span class="s2">"Food_Category"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">sales_df</span><span class="p">[</span><span class="s2">"Food_Category"</span><span class="p">])</span>
<span class="n">sales_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>customers</th>
<th>sales</th>
<th>Food_Category</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>31</td>
<td>459.895203</td>
<td>Pizza</td>
</tr>
<tr>
<th>1</th>
<td>31</td>
<td>401.147736</td>
<td>Pizza</td>
</tr>
<tr>
<th>2</th>
<td>31</td>
<td>413.345245</td>
<td>Pizza</td>
</tr>
<tr>
<th>3</th>
<td>31</td>
<td>371.909241</td>
<td>Pizza</td>
</tr>
<tr>
<th>4</th>
<td>32</td>
<td>433.797089</td>
<td>Pizza</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>463</th>
<td>100</td>
<td>611.736816</td>
<td>Sandwich</td>
</tr>
<tr>
<th>464</th>
<td>100</td>
<td>667.152954</td>
<td>Sandwich</td>
</tr>
<tr>
<th>465</th>
<td>42</td>
<td>331.625702</td>
<td>Salad</td>
</tr>
<tr>
<th>466</th>
<td>66</td>
<td>520.900940</td>
<td>Salad</td>
</tr>
<tr>
<th>467</th>
<td>75</td>
<td>628.937622</td>
<td>Salad</td>
</tr>
</tbody>
</table>
<p>468 rows × 3 columns</p>
</div></div></div>
</div>
<section id="figure-4-10">
<h3>Figure 4.10<a class="headerlink" href="#figure-4-10" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>
<span class="n">pizza_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C1"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Pizza"</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"^"</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">);</span>
<span class="n">sandwich_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s2">"Sandwich"</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"s"</span><span class="p">);</span>
<span class="n">salad_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Salad"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Number of Customers"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Daily Sales Dollars"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Aggregated Sales Dollars"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s1">'img/chp04/restaurant_order_scatter.png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/97465c9d7f9ba4a071675f1ff29e8c95768f95b01eec8c4ce9088cc05024ca74.png" src="../_images/97465c9d7f9ba4a071675f1ff29e8c95768f95b01eec8c4ce9088cc05024ca74.png"/>
</div>
</div>
</section>
<section id="unpooled-model">
<h3>Unpooled Model<a class="headerlink" href="#unpooled-model" title="Permalink to this heading">#</a></h3>
</section>
<section id="code-4-9">
<h3>Code 4.9<a class="headerlink" href="#code-4-9" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">customers</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"customers"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">sales_observed</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"sales"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">food_category</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">sales_df</span><span class="p">[</span><span class="s2">"Food_Category"</span><span class="p">])</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_sales_unpooled</span><span class="p">:</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span><span class="p">[</span><span class="n">food_category</span><span class="o">.</span><span class="n">codes</span><span class="p">]</span> <span class="o">*</span><span class="n">customers</span><span class="p">)</span>
    
    <span class="n">sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">[</span><span class="n">food_category</span><span class="o">.</span><span class="n">codes</span><span class="p">],</span>
                      <span class="n">observed</span><span class="o">=</span><span class="n">sales_observed</span><span class="p">)</span>
    
    <span class="n">trace_sales_unpooled</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">target_accept</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>
    <span class="n">inf_data_sales_unpooled</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span>
        <span class="n">trace</span><span class="o">=</span><span class="n">trace_sales_unpooled</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">"β_dim_0"</span><span class="p">:</span><span class="n">food_category</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span>
                <span class="s2">"σ_dim_0"</span><span class="p">:</span><span class="n">food_category</span><span class="o">.</span><span class="n">categories</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/3049063767.py:14: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_sales_unpooled = pm.sample(target_accept=.9)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [β, σ]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:05&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 14 seconds.
</pre></div>
</div>
</div>
</div>
</section>
<section id="figure-4-12">
<h3>Figure 4.12<a class="headerlink" href="#figure-4-12" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sales_unpooled_diagram</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model_sales_unpooled</span><span class="p">)</span>
<span class="n">sales_unpooled_diagram</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_model_unpooled"</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sales_unpooled_diagram</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/704f876828c7d7ed6abecf46583f65abd1939d57d9f83cb19013fa56da5ea5a1.svg" src="../_images/704f876828c7d7ed6abecf46583f65abd1939d57d9f83cb19013fa56da5ea5a1.svg"/></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inf_data_salads_sales_unpooled</span> <span class="o">=</span> <span class="n">inf_data_sales_unpooled</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">β_dim_0</span><span class="o">=</span><span class="s2">"Salad"</span><span class="p">,</span> <span class="n">μ_dim_0</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">465</span><span class="p">,</span> <span class="mi">467</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_sales_unpooled</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr>
<th>β[0]</th>
<td>13.025</td>
<td>0.030</td>
<td>12.970</td>
<td>13.081</td>
<td>0.000</td>
<td>0.000</td>
<td>5104.0</td>
<td>2785.0</td>
<td>1.0</td>
</tr>
<tr>
<th>β[1]</th>
<td>8.129</td>
<td>0.214</td>
<td>7.720</td>
<td>8.561</td>
<td>0.004</td>
<td>0.003</td>
<td>3504.0</td>
<td>2280.0</td>
<td>1.0</td>
</tr>
<tr>
<th>β[2]</th>
<td>6.111</td>
<td>0.052</td>
<td>6.010</td>
<td>6.204</td>
<td>0.001</td>
<td>0.001</td>
<td>5298.0</td>
<td>2765.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ[0]</th>
<td>40.128</td>
<td>1.469</td>
<td>37.362</td>
<td>42.801</td>
<td>0.020</td>
<td>0.014</td>
<td>5405.0</td>
<td>2605.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ[1]</th>
<td>21.361</td>
<td>8.327</td>
<td>8.919</td>
<td>37.105</td>
<td>0.158</td>
<td>0.116</td>
<td>3148.0</td>
<td>3021.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ[2]</th>
<td>35.931</td>
<td>2.506</td>
<td>31.092</td>
<td>40.501</td>
<td>0.034</td>
<td>0.024</td>
<td>5377.0</td>
<td>2902.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_trace.html#arviz.plot_trace" title="arviz.plot_trace"><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span></a><span class="p">(</span><span class="n">inf_data_sales_unpooled</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">],</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d8eb04a46da20dde9264e2bce7634064d3f27a242031dab5364b0239366a27b9.png" src="../_images/d8eb04a46da20dde9264e2bce7634064d3f27a242031dab5364b0239366a27b9.png"/>
</div>
</div>
</section>
<section id="figure-4-13">
<h3>Figure 4.13<a class="headerlink" href="#figure-4-13" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">([</span><span class="n">inf_data_sales_unpooled</span><span class="p">],</span>
                      <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Unpooled"</span><span class="p">,],</span>
                      <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">));</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"β parameter estimates 94% HDI"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_forestplot_beta.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/485f8371fb87baffceff7095d4c4378d04edb9783dc985c0a8bb3bf6add0cf86.png" src="../_images/485f8371fb87baffceff7095d4c4378d04edb9783dc985c0a8bb3bf6add0cf86.png"/>
</div>
</div>
</section>
<section id="figure-4-14">
<h3>Figure 4.14<a class="headerlink" href="#figure-4-14" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">([</span><span class="n">inf_data_salads_sales_unpooled</span><span class="p">,],</span>
                      <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Unpooled"</span><span class="p">,],</span>
                      <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">));</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"σ parameter estimates 94% HDI"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_forestplot_sigma.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/57856cc75ce6aa263e12ed87f68e9019ad1cc607fd53d7950d8453c65336bf5f.png" src="../_images/57856cc75ce6aa263e12ed87f68e9019ad1cc607fd53d7950d8453c65336bf5f.png"/>
</div>
</div>
</section>
<section id="pooled-model">
<h3>Pooled Model<a class="headerlink" href="#pooled-model" title="Permalink to this heading">#</a></h3>
</section>
<section id="code-4-10">
<h3>Code 4.10<a class="headerlink" href="#code-4-10" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_sales_pooled</span><span class="p">:</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span> <span class="o">*</span> <span class="n">customers</span><span class="p">)</span>
    
    <span class="n">sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">,</span>
                      <span class="n">observed</span><span class="o">=</span><span class="n">sales_observed</span><span class="p">)</span>
                        
    <span class="n">inf_data_sales_pooled</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/1895007518.py:10: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  inf_data_sales_pooled = pm.sample()
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [β, σ]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:02&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 11 seconds.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model_sales_pooled</span><span class="p">:</span>
    <span class="n">ppc_sales_pooled</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">inf_data_sales_pooled</span><span class="p">)</span>
    <span class="n">inf_data_sales_pooled</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span>
        <span class="n">trace</span><span class="o">=</span><span class="n">inf_data_sales_pooled</span><span class="p">,</span>
        <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc_sales_pooled</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="4000" style="width:300px; height:20px; vertical-align: middle;" value="4000"></progress>
      100.00% [4000/4000 00:03&lt;00:00]
    </div>
</div></div>
</div>
</section>
<section id="figure-4-16">
<h3>Figure 4.16<a class="headerlink" href="#figure-4-16" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pooled_sales_diagram</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model_sales_pooled</span><span class="p">)</span>
<span class="n">pooled_sales_diagram</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_model_pooled"</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pooled_sales_diagram</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e6f72e358bdcd8564fecb62cdf6844657039917c8ca5f94d89666459fd10d6c9.svg" src="../_images/e6f72e358bdcd8564fecb62cdf6844657039917c8ca5f94d89666459fd10d6c9.svg"/></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_trace.html#arviz.plot_trace" title="arviz.plot_trace"><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span></a><span class="p">(</span><span class="n">inf_data_sales_pooled</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">],</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1c20f18c227aa4d279be7007b14920b44e05e302ce65f649ff13ecf37b2918db.png" src="../_images/1c20f18c227aa4d279be7007b14920b44e05e302ce65f649ff13ecf37b2918db.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_sales_pooled</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr>
<th>β</th>
<td>11.498</td>
<td>0.126</td>
<td>11.264</td>
<td>11.729</td>
<td>0.002</td>
<td>0.001</td>
<td>3561.0</td>
<td>2629.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ</th>
<td>186.204</td>
<td>5.271</td>
<td>176.336</td>
<td>195.841</td>
<td>0.090</td>
<td>0.063</td>
<td>3466.0</td>
<td>3240.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
<section id="figure-4-17">
<h3>Figure 4.17<a class="headerlink" href="#figure-4-17" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">([</span><span class="n">inf_data_sales_pooled</span><span class="p">,</span> <span class="n">inf_data_sales_unpooled</span><span class="p">],</span>
                      <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Pooled"</span><span class="p">,</span> <span class="s2">"Unpooled"</span><span class="p">],</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">));</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Comparison of pooled and unpooled models </span><span class="se">\n</span><span class="s2"> 94% HDI"</span><span class="p">)</span>

<span class="c1">#plt.subplots_adjust(top=1)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_forestplot_sigma_comparison.png"</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5abfa819da4f3b92d766cc1a9f0417bd8eba943a39152f3308e919a7e68f4814.png" src="../_images/5abfa819da4f3b92d766cc1a9f0417bd8eba943a39152f3308e919a7e68f4814.png"/>
</div>
</div>
</section>
<section id="figure-4-18">
<h3>Figure 4.18<a class="headerlink" href="#figure-4-18" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">μ_m</span> <span class="o">=</span> <span class="n">inf_data_sales_pooled</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">σ_m</span> <span class="o">=</span> <span class="n">inf_data_sales_pooled</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">μ_m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">inf_data_sales_pooled</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">inf_data_sales_pooled</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.94</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>


<span class="n">pizza_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C1"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Pizza"</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"^"</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">);</span>
<span class="n">sandwich_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s2">"Sandwich"</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"s"</span><span class="p">);</span>
<span class="n">salad_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Salad"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">);</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Number of Customers"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Daily Sales Dollars"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Pooled Regression"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_scatter_pooled.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/811b5475339fd8c39c4da6373e73d0590e012a319cb91cddfd11cfdefe7d4d1f.png" src="../_images/811b5475339fd8c39c4da6373e73d0590e012a319cb91cddfd11cfdefe7d4d1f.png"/>
</div>
</div>
</section>
<section id="code-4-11">
<h3>Code 4.11<a class="headerlink" href="#code-4-11" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_pooled_sigma_sales</span><span class="p">:</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span><span class="p">[</span><span class="n">food_category</span><span class="o">.</span><span class="n">codes</span><span class="p">]</span> <span class="o">*</span> <span class="n">customers</span><span class="p">)</span>
    
    <span class="n">sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">sales_observed</span><span class="p">)</span>
    
    <span class="n">trace_pooled_sigma_sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="n">ppc_pooled_sigma_sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span>
        <span class="n">trace_pooled_sigma_sales</span><span class="p">)</span>

    <span class="n">inf_data_pooled_sigma_sales</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span>
        <span class="n">trace</span><span class="o">=</span><span class="n">trace_pooled_sigma_sales</span><span class="p">,</span>
        <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc_pooled_sigma_sales</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">"β_dim_0"</span><span class="p">:</span><span class="n">food_category</span><span class="o">.</span><span class="n">categories</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/2977589499.py:9: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_pooled_sigma_sales = pm.sample()
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [β, σ]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:03&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 12 seconds.
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="4000" style="width:300px; height:20px; vertical-align: middle;" value="4000"></progress>
      100.00% [4000/4000 00:03&lt;00:00]
    </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multilevel_sales_diagram</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model_pooled_sigma_sales</span><span class="p">)</span>
<span class="n">multilevel_sales_diagram</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_model_multilevel"</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">multilevel_sales_diagram</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/591bda2333294bb384e58fbd36f14157ed2f20f198d7ba5886c8023f1fb5050e.svg" src="../_images/591bda2333294bb384e58fbd36f14157ed2f20f198d7ba5886c8023f1fb5050e.svg"/></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_pooled_sigma_sales</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr>
<th>β[0]</th>
<td>13.025</td>
<td>0.030</td>
<td>12.971</td>
<td>13.082</td>
<td>0.000</td>
<td>0.000</td>
<td>7261.0</td>
<td>3250.0</td>
<td>1.0</td>
</tr>
<tr>
<th>β[1]</th>
<td>8.128</td>
<td>0.366</td>
<td>7.441</td>
<td>8.776</td>
<td>0.005</td>
<td>0.003</td>
<td>6291.0</td>
<td>3066.0</td>
<td>1.0</td>
</tr>
<tr>
<th>β[2]</th>
<td>6.113</td>
<td>0.059</td>
<td>6.003</td>
<td>6.226</td>
<td>0.001</td>
<td>0.001</td>
<td>6336.0</td>
<td>2674.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ</th>
<td>39.257</td>
<td>1.318</td>
<td>36.809</td>
<td>41.689</td>
<td>0.017</td>
<td>0.012</td>
<td>6281.0</td>
<td>2926.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
<section id="figure-4-20">
<h3>Figure 4.20<a class="headerlink" href="#figure-4-20" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">σ_m</span> <span class="o">=</span> <span class="n">inf_data_sales_pooled</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Salads</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">category_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">food_category</span><span class="o">.</span><span class="n">codes</span><span class="o">==</span><span class="n">i</span><span class="p">)</span>
    <span class="n">μ_m_salads</span> <span class="o">=</span> <span class="n">inf_data_pooled_sigma_sales</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"μ"</span><span class="p">][:,:,</span> <span class="n">category_mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sales_df</span><span class="o">.</span><span class="n">customers</span><span class="p">[</span><span class="n">category_mask</span><span class="p">],</span> <span class="n">μ_m_salads</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'C4'</span><span class="p">)</span>
    <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">sales_df</span><span class="o">.</span><span class="n">customers</span><span class="p">[</span><span class="n">category_mask</span><span class="p">],</span> <span class="n">inf_data_pooled_sigma_sales</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">][:,:,</span> <span class="p">(</span><span class="n">category_mask</span><span class="p">)],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fill_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"alpha"</span><span class="p">:</span> <span class="mf">.5</span><span class="p">})</span>
    <span class="c1">#az.plot_hdi(sales_df.customers[category_mask], inf_data_pooled_sigma_sales.posterior_predictive["sales"][:,:, (category_mask)], hdi_prob=.94, ax=ax)</span>


<span class="n">pizza_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C1"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Pizza"</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"^"</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">);</span>
<span class="n">sandwich_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s2">"Sandwich"</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"s"</span><span class="p">);</span>
<span class="n">salad_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Salad"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">);</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Number of Customers"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Daily Sales Dollars"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Unpooled Slope Pooled Sigma Regression"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_basic_regression_scatter_sigma_pooled_slope_unpooled.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1167b0b5d026aa53920b0c1fd7052fba048c4d22c2c782a8554a0dcf6f688eea.png" src="../_images/1167b0b5d026aa53920b0c1fd7052fba048c4d22c2c782a8554a0dcf6f688eea.png"/>
</div>
</div>
</section>
<section id="figure-4-21">
<h3>Figure 4.21<a class="headerlink" href="#figure-4-21" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">([</span><span class="n">inf_data_sales_unpooled</span><span class="p">,</span>
                       <span class="n">inf_data_pooled_sigma_sales</span>
                      <span class="p">],</span>
                      <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Unpooled"</span><span class="p">,</span>
                                     <span class="s2">"Multilevel "</span>
                                    <span class="p">],</span>
                      <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">));</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Comparison of σ parameters 94% HDI"</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_forestplot_sigma_unpooled_multilevel_comparison.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a1b470e542d4002633295d112c2fb2954b812c71ac1c7b44e6ac17b46ff4bd86.png" src="../_images/a1b470e542d4002633295d112c2fb2954b812c71ac1c7b44e6ac17b46ff4bd86.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">([</span><span class="n">inf_data_sales_unpooled</span><span class="p">,</span>
                       <span class="n">inf_data_pooled_sigma_sales</span>
                      <span class="p">],</span>
                      <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Unpooled"</span><span class="p">,</span>
                                     <span class="s2">"Multilevel"</span>
                                    <span class="p">],</span>
                      <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">));</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Comparison of β parameters 94% HDI"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, 'Comparison of β parameters 94% HDI')
</pre></div>
</div>
<img alt="../_images/5078c492339af079f671452f410a887f721aca47bda4e082cb272973bce8d554.png" src="../_images/5078c492339af079f671452f410a887f721aca47bda4e082cb272973bce8d554.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inf_posterior_salads</span> <span class="o">=</span> <span class="n">inf_data_pooled_sigma_sales</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">β_dim_0</span><span class="o">=</span><span class="s2">"Salad"</span><span class="p">,</span> <span class="n">μ_dim_0</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">465</span><span class="p">,</span> <span class="mi">467</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="hierarchical">
<h3>Hierarchical<a class="headerlink" href="#hierarchical" title="Permalink to this heading">#</a></h3>
</section>
<section id="code-4-12">
<h3>Code 4.12<a class="headerlink" href="#code-4-12" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_hierarchical_sales</span><span class="p">:</span>
    <span class="n">σ_hyperprior</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ_hyperprior"</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">σ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s2">"σ"</span><span class="p">,</span> <span class="n">σ_hyperprior</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">β</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"β"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">μ</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">"μ"</span><span class="p">,</span> <span class="n">β</span><span class="p">[</span><span class="n">food_category</span><span class="o">.</span><span class="n">codes</span><span class="p">]</span> <span class="o">*</span> <span class="n">customers</span><span class="p">)</span>
    
    <span class="n">sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">μ</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">σ</span><span class="p">[</span><span class="n">food_category</span><span class="o">.</span><span class="n">codes</span><span class="p">],</span>
                      <span class="n">observed</span><span class="o">=</span><span class="n">sales_observed</span><span class="p">)</span>
    
    <span class="n">trace_hierarchical_sales</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">target_accept</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>
    
    <span class="n">inf_data_hierarchical_sales</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pymc3</span><span class="p">(</span>
        <span class="n">trace</span><span class="o">=</span><span class="n">trace_hierarchical_sales</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">"β_dim_0"</span><span class="p">:</span><span class="n">food_category</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span>
                <span class="s2">"σ_dim_0"</span><span class="p">:</span><span class="n">food_category</span><span class="o">.</span><span class="n">categories</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/7p/srk5qjp563l5f9mrjtp44bh800jqsw/T/ipykernel_8872/2572718925.py:11: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace_hierarchical_sales = pm.sample(target_accept=.9)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [β, σ, σ_hyperprior]
</pre></div>
</div>
<div class="output text_html">
<div>
<style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
<progress class="" max="8000" style="width:300px; height:20px; vertical-align: middle;" value="8000"></progress>
      100.00% [8000/8000 00:05&lt;00:00 Sampling 4 chains, 7 divergences]
    </div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 15 seconds.
There were 5 divergences after tuning. Increase `target_accept` or reparameterize.
There were 2 divergences after tuning. Increase `target_accept` or reparameterize.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_trace.html#arviz.plot_trace" title="arviz.plot_trace"><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span></a><span class="p">(</span><span class="n">inf_data_hierarchical_sales</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">,</span> <span class="s2">"σ_hyperprior"</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6a0dd0935df45d1931e3f3de0ee52842d2756954c5c6183f03e729a3c4c8d609.png" src="../_images/6a0dd0935df45d1931e3f3de0ee52842d2756954c5c6183f03e729a3c4c8d609.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_parallel.html#arviz.plot_parallel" title="arviz.plot_parallel"><span class="n">az</span><span class="o">.</span><span class="n">plot_parallel</span></a><span class="p">(</span><span class="n">inf_data_hierarchical_sales</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">,</span> <span class="s2">"σ_hyperprior"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/99b704342a9eb78b9675fd1a4bf0a714381faee79c88d30a4995e8e7b051e460.png" src="../_images/99b704342a9eb78b9675fd1a4bf0a714381faee79c88d30a4995e8e7b051e460.png"/>
</div>
</div>
</section>
<section id="figure-4-23">
<h3>Figure 4.23<a class="headerlink" href="#figure-4-23" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hierarchial_sales_diagram</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model_hierarchical_sales</span><span class="p">)</span>
<span class="n">hierarchial_sales_diagram</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"img/chp04/salad_sales_hierarchial_regression_model"</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hierarchial_sales_diagram</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4a72064a42f8bd8fd5f4109defad4d495e13c70b0dc958ffcb74aeb5a04e3a0f.svg" src="../_images/4a72064a42f8bd8fd5f4109defad4d495e13c70b0dc958ffcb74aeb5a04e3a0f.svg"/></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_hierarchical_sales</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">,</span> <span class="s2">"σ"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr>
<th>β[0]</th>
<td>13.025</td>
<td>0.031</td>
<td>12.968</td>
<td>13.082</td>
<td>0.000</td>
<td>0.000</td>
<td>5196.0</td>
<td>2491.0</td>
<td>1.0</td>
</tr>
<tr>
<th>β[1]</th>
<td>8.131</td>
<td>0.275</td>
<td>7.613</td>
<td>8.641</td>
<td>0.006</td>
<td>0.004</td>
<td>2558.0</td>
<td>1788.0</td>
<td>1.0</td>
</tr>
<tr>
<th>β[2]</th>
<td>6.113</td>
<td>0.053</td>
<td>6.012</td>
<td>6.208</td>
<td>0.001</td>
<td>0.001</td>
<td>4419.0</td>
<td>2689.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ[0]</th>
<td>40.261</td>
<td>1.474</td>
<td>37.489</td>
<td>43.064</td>
<td>0.021</td>
<td>0.015</td>
<td>4979.0</td>
<td>2825.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ[1]</th>
<td>26.007</td>
<td>13.588</td>
<td>7.889</td>
<td>50.398</td>
<td>0.304</td>
<td>0.215</td>
<td>2404.0</td>
<td>2152.0</td>
<td>1.0</td>
</tr>
<tr>
<th>σ[2]</th>
<td>36.274</td>
<td>2.604</td>
<td>31.514</td>
<td>41.230</td>
<td>0.038</td>
<td>0.027</td>
<td>4816.0</td>
<td>2676.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">(</span><span class="n">inf_data_hierarchical_sales</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"β"</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Hierarchical β estimates 94% HDI"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, 'Hierarchical β estimates 94% HDI')
</pre></div>
</div>
<img alt="../_images/afd4797e9a8de1ac6ab796de0cfdbbd219430a53f9a01b33300d07d8b526cb81.png" src="../_images/afd4797e9a8de1ac6ab796de0cfdbbd219430a53f9a01b33300d07d8b526cb81.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">(</span><span class="n">inf_data_hierarchical_sales</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">,</span> <span class="s2">"σ_hyperprior"</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Hierarchical σ estimates 94% HDI"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_forestplot_sigma_hierarchical.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8316bb91a5aa7a6381d320a430b23b51fa54ebd0e10af26256edb6cd827d16e1.png" src="../_images/8316bb91a5aa7a6381d320a430b23b51fa54ebd0e10af26256edb6cd827d16e1.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">food_category</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index(['Pizza', 'Salad', 'Sandwich'], dtype='object')
</pre></div>
</div>
</div>
</div>
</section>
<section id="table-4-3">
<h3>Table 4.3<a class="headerlink" href="#table-4-3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_sales_unpooled</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"stats"</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
</tr>
</thead>
<tbody>
<tr>
<th>σ[0]</th>
<td>40.1</td>
<td>1.5</td>
<td>37.4</td>
<td>42.8</td>
</tr>
<tr>
<th>σ[1]</th>
<td>21.4</td>
<td>8.3</td>
<td>8.9</td>
<td>37.1</td>
</tr>
<tr>
<th>σ[2]</th>
<td>35.9</td>
<td>2.5</td>
<td>31.1</td>
<td>40.5</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
<section id="table-4-4">
<h3>Table 4.4<a class="headerlink" href="#table-4-4" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">inf_data_hierarchical_sales</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">,</span> <span class="s2">"σ_hyperprior"</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"stats"</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
</tr>
</thead>
<tbody>
<tr>
<th>σ[0]</th>
<td>40.3</td>
<td>1.5</td>
<td>37.5</td>
<td>43.1</td>
</tr>
<tr>
<th>σ[1]</th>
<td>26.0</td>
<td>13.6</td>
<td>7.9</td>
<td>50.4</td>
</tr>
<tr>
<th>σ[2]</th>
<td>36.3</td>
<td>2.6</td>
<td>31.5</td>
<td>41.2</td>
</tr>
<tr>
<th>σ_hyperprior</th>
<td>31.7</td>
<td>9.1</td>
<td>16.6</td>
<td>48.4</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">axes</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_forest.html#arviz.plot_forest" title="arviz.plot_forest"><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span></a><span class="p">([</span><span class="n">inf_data_sales_unpooled</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">σ_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                       <span class="n">inf_data_hierarchical_sales</span>
                      <span class="p">],</span>
                      <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"sales_unpooled"</span><span class="p">,</span>
                                     <span class="s2">"sales_hierarchical"</span>
                                    <span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">),</span>
                     <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">,</span> <span class="s2">"σ_hyperprior"</span><span class="p">]</span>
                     <span class="p">);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Comparison of σ parameters from unpooled </span><span class="se">\n</span><span class="s2"> and hierarchical models </span><span class="se">\n</span><span class="s2"> 94% HDI"</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/salad_sales_forestolot_sigma_unpooled_multilevel_comparison.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/44e8e65f9a1476c699145892fd1e173e61ea820062194a7421ed09018013f0d0.png" src="../_images/44e8e65f9a1476c699145892fd1e173e61ea820062194a7421ed09018013f0d0.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_kde.html#arviz.plot_kde" title="arviz.plot_kde"><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span></a><span class="p">(</span><span class="n">inf_data_sales_unpooled</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">'σ'</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">σ_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unpooled Salad Sigma"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_kde.html#arviz.plot_kde" title="arviz.plot_kde"><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span></a><span class="p">(</span><span class="n">inf_data_hierarchical_sales</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">"σ"</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">σ_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Hierarchical Salad Sigma"</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"color"</span><span class="p">:</span><span class="s2">"C4"</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Comparison of Hierarchical versus Unpooled Variance"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, 'Comparison of Hierarchical versus Unpooled Variance')
</pre></div>
</div>
<img alt="../_images/0e92bbbbe01dd4065b5dd4f0349116aa7eb6365b28bb116e5fe9d46e54300c3c.png" src="../_images/0e92bbbbe01dd4065b5dd4f0349116aa7eb6365b28bb116e5fe9d46e54300c3c.png"/>
</div>
</div>
</section>
<section id="figure-4-25">
<h3>Figure 4.25<a class="headerlink" href="#figure-4-25" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsample</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">nd</span><span class="o">=</span><span class="mi">1</span>
<span class="n">yr</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nsample</span><span class="p">)</span>
<span class="n">xnr</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.exp.html#numpy.exp" title="numpy.exp"><span class="n">np</span><span class="o">.</span><span class="n">exp</span></a><span class="p">(</span><span class="n">yr</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">nsample</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xnr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'y'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, 'y')
</pre></div>
</div>
<img alt="../_images/ab9d842cf50f8cfe48338b7464cbc4da00dcf49c5d553deb3b4b792d7c5fa034.png" src="../_images/ab9d842cf50f8cfe48338b7464cbc4da00dcf49c5d553deb3b4b792d7c5fa034.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">salad_generator</span><span class="p">(</span><span class="n">hyperprior_beta_mean</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">hyperprior_beta_sigma</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">days_per_location</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">sigma_per_location</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">20</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">"""Generate noisy salad data"""</span>
    <span class="n">beta_hyperprior</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.norm.html#scipy.stats.norm" title="scipy.stats.norm"><span class="n">stats</span><span class="o">.</span><span class="n">norm</span></a><span class="p">(</span><span class="n">hyperprior_beta_mean</span><span class="p">,</span> <span class="n">hyperprior_beta_sigma</span><span class="p">)</span>
    
    <span class="c1"># Generate demands days per restaurant</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">days</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">days_per_location</span><span class="p">):</span>
        <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.seed.html#numpy.random.seed" title="numpy.random.seed"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span></a><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">num_customers</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.randint.html#scipy.stats.randint" title="scipy.stats.randint"><span class="n">stats</span><span class="o">.</span><span class="n">randint</span></a><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>
        <span class="n">sales_location</span> <span class="o">=</span> <span class="n">beta_hyperprior</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span><span class="o">*</span><span class="n">num_customers</span> <span class="o">+</span> <a class="sphinx-codeautolink-a" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.norm.html#scipy.stats.norm" title="scipy.stats.norm"><span class="n">stats</span><span class="o">.</span><span class="n">norm</span></a><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma_per_location</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">num_customers</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">location_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"customers"</span><span class="p">:</span><span class="n">num_customers</span><span class="p">,</span> <span class="s2">"sales"</span><span class="p">:</span><span class="n">sales_location</span><span class="p">})</span>
        <span class="n">location_df</span><span class="p">[</span><span class="s2">"location"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">location_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">location_df</span><span class="p">])</span>
        
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
<span class="n">hierarchical_salad_df</span> <span class="o">=</span> <span class="n">salad_generator</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="figure-4-26">
<h3>Figure 4.26<a class="headerlink" href="#figure-4-26" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
    <span class="n">location_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">hierarchical_salad_df</span><span class="p">[</span><span class="s2">"location"</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">hierarchical_salad_df</span><span class="p">[</span><span class="n">location_filter</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">"customers"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>

    
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Number of Customers"</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Sales"</span><span class="p">);</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/multiple_salad_sales_scatter.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fd0f31e0d3d68e6e91de398f5ff8f7dc5f7c2391a6decea490d33098fa69fcfc.png" src="../_images/fd0f31e0d3d68e6e91de398f5ff8f7dc5f7c2391a6decea490d33098fa69fcfc.png"/>
</div>
</div>
</section>
<section id="code-4-13">
<h3>Code 4.13<a class="headerlink" href="#code-4-13" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>

<span class="n">tfd</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="o">.</span><span class="n">Root</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">run_mcmc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
    <span class="n">tfp</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">windowed_adaptive_nuts</span><span class="p">,</span>
    <span class="n">autograph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jit_compile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_hierarchical_salad_sales</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span> <span class="n">beta_prior_fn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="n">customers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
        <span class="n">hierarchical_salad_df</span><span class="p">[</span><span class="s2">"customers"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">location_category</span> <span class="o">=</span> <span class="n">hierarchical_salad_df</span><span class="p">[</span><span class="s2">"location"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">sales</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">hierarchical_salad_df</span><span class="p">[</span><span class="s2">"sales"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="nd">@tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span>
    <span class="k">def</span> <span class="nf">model_hierarchical_salad_sales</span><span class="p">():</span>
        <span class="n">β_μ_hyperprior</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"beta_mu"</span><span class="p">))</span>
        <span class="n">β_σ_hyperprior</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"beta_sigma"</span><span class="p">))</span>
        <span class="n">β</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">beta_prior_fn</span><span class="p">(</span><span class="n">β_μ_hyperprior</span><span class="p">,</span> <span class="n">β_σ_hyperprior</span><span class="p">)</span>

        <span class="n">σ_hyperprior</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"sigma_prior"</span><span class="p">))</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">σ_hyperprior</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"sigma"</span><span class="p">)</span>

        <span class="n">loc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">β</span><span class="p">,</span> <span class="n">location_category</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">customers</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">σ</span><span class="p">,</span> <span class="n">location_category</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sales</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>
                                      <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s2">"sales"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model_hierarchical_salad_sales</span><span class="p">,</span> <span class="n">sales</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="code-4-14-and-4-15">
<h3>Code 4.14 and 4.15<a class="headerlink" href="#code-4-14-and-4-15" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">centered_beta_prior_fn</span><span class="p">(</span><span class="n">hyper_mu</span><span class="p">,</span> <span class="n">hyper_sigma</span><span class="p">):</span>
    <span class="n">β</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">hyper_mu</span><span class="p">,</span> <span class="n">hyper_sigma</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"beta"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">β</span>

<span class="c1"># hierarchical_salad_df is the generated dataset as pandas.DataFrame</span>
<span class="n">centered_model</span><span class="p">,</span> <span class="n">observed</span> <span class="o">=</span> <span class="n">gen_hierarchical_salad_sales</span><span class="p">(</span>
    <span class="n">hierarchical_salad_df</span><span class="p">,</span> <span class="n">centered_beta_prior_fn</span><span class="p">)</span>

<span class="n">mcmc_samples_centered</span><span class="p">,</span> <span class="n">sampler_stats_centered</span> <span class="o">=</span> <span class="n">run_mcmc</span><span class="p">(</span>
    <span class="mi">1000</span><span class="p">,</span> <span class="n">centered_model</span><span class="p">,</span> <span class="n">n_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_adaptation_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">sales</span><span class="o">=</span><span class="n">observed</span><span class="p">)</span>

<span class="n">divergent_per_chain</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sum.html#numpy.sum" title="numpy.sum"><span class="n">np</span><span class="o">.</span><span class="n">sum</span></a><span class="p">(</span><span class="n">sampler_stats_centered</span><span class="p">[</span><span class="s1">'diverging'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"""There were </span><span class="si">{</span><span class="n">divergent_per_chain</span><span class="si">}</span><span class="s2"> divergences after tuning per chain."""</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/tensorflow_probability/python/distributions/distribution.py:342: calling MultivariateNormalDiag.__init__ (from tensorflow_probability.python.distributions.mvn_diag) with scale_identity_multiplier is deprecated and will be removed after 2020-01-01.
Instructions for updating:
`scale_identity_multiplier` is deprecated; please combine it into `scale_diag` directly instead.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-11-19 16:49:41.809766: W tensorflow/compiler/tf2xla/kernels/random_ops.cc:102] Warning: Using tf.random.uniform with XLA compilation will ignore seeds; consider using tf.random.stateless_uniform instead if reproducible behavior is desired. sanitize_seed/seed
2021-11-19 16:49:41.952731: W tensorflow/compiler/tf2xla/kernels/assert_op.cc:38] Ignoring Assert operator mcmc_retry_init/assert_equal_1/Assert/AssertGuard/Assert
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There were [ 24 112 194  44] divergences after tuning per chain.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idata_centered_model</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.from_dict.html#arviz.from_dict" title="arviz.from_dict"><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span></a><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span>
        <span class="n">k</span><span class="p">:</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.swapaxes.html#numpy.swapaxes" title="numpy.swapaxes"><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span></a><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mcmc_samples_centered</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">sample_stats</span><span class="o">=</span><span class="p">{</span>
        <span class="n">k</span><span class="p">:</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.swapaxes.html#numpy.swapaxes" title="numpy.swapaxes"><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span></a><span class="p">(</span><span class="n">sampler_stats_centered</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"target_log_prob"</span><span class="p">,</span> <span class="s2">"diverging"</span><span class="p">,</span> <span class="s2">"accept_ratio"</span><span class="p">,</span> <span class="s2">"n_steps"</span><span class="p">]}</span>
<span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_trace.html#arviz.plot_trace" title="arviz.plot_trace"><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span></a><span class="p">(</span><span class="n">idata_centered_model</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b09315880231fe959255066ee24972b5e2fcf7c6440fbbae14173c8cd23845e1.png" src="../_images/b09315880231fe959255066ee24972b5e2fcf7c6440fbbae14173c8cd23845e1.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">idata_centered_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr>
<th>beta_mu</th>
<td>5.053</td>
<td>0.071</td>
<td>4.911</td>
<td>5.179</td>
<td>0.003</td>
<td>0.002</td>
<td>451.0</td>
<td>1462.0</td>
<td>1.02</td>
</tr>
<tr>
<th>beta_sigma</th>
<td>0.072</td>
<td>0.053</td>
<td>0.008</td>
<td>0.167</td>
<td>0.004</td>
<td>0.003</td>
<td>90.0</td>
<td>54.0</td>
<td>1.05</td>
</tr>
<tr>
<th>beta[0]</th>
<td>5.012</td>
<td>0.118</td>
<td>4.759</td>
<td>5.217</td>
<td>0.004</td>
<td>0.003</td>
<td>653.0</td>
<td>1563.0</td>
<td>1.02</td>
</tr>
<tr>
<th>beta[1]</th>
<td>5.042</td>
<td>0.071</td>
<td>4.908</td>
<td>5.174</td>
<td>0.003</td>
<td>0.002</td>
<td>591.0</td>
<td>1775.0</td>
<td>1.02</td>
</tr>
<tr>
<th>beta[2]</th>
<td>5.087</td>
<td>0.073</td>
<td>4.949</td>
<td>5.225</td>
<td>0.003</td>
<td>0.002</td>
<td>713.0</td>
<td>1453.0</td>
<td>1.01</td>
</tr>
<tr>
<th>beta[3]</th>
<td>5.057</td>
<td>0.100</td>
<td>4.865</td>
<td>5.261</td>
<td>0.003</td>
<td>0.002</td>
<td>855.0</td>
<td>1370.0</td>
<td>1.01</td>
</tr>
<tr>
<th>beta[4]</th>
<td>5.076</td>
<td>0.112</td>
<td>4.864</td>
<td>5.289</td>
<td>0.003</td>
<td>0.002</td>
<td>1059.0</td>
<td>1600.0</td>
<td>1.01</td>
</tr>
<tr>
<th>beta[5]</th>
<td>5.041</td>
<td>0.077</td>
<td>4.878</td>
<td>5.176</td>
<td>0.002</td>
<td>0.002</td>
<td>724.0</td>
<td>1966.0</td>
<td>1.01</td>
</tr>
<tr>
<th>sigma_prior</th>
<td>48.410</td>
<td>12.377</td>
<td>27.661</td>
<td>71.280</td>
<td>0.427</td>
<td>0.302</td>
<td>905.0</td>
<td>1645.0</td>
<td>1.01</td>
</tr>
<tr>
<th>sigma[0]</th>
<td>59.925</td>
<td>16.018</td>
<td>35.037</td>
<td>90.595</td>
<td>0.715</td>
<td>0.506</td>
<td>379.0</td>
<td>340.0</td>
<td>1.02</td>
</tr>
<tr>
<th>sigma[1]</th>
<td>17.692</td>
<td>9.324</td>
<td>6.065</td>
<td>32.821</td>
<td>0.774</td>
<td>0.548</td>
<td>203.0</td>
<td>1209.0</td>
<td>1.03</td>
</tr>
<tr>
<th>sigma[2]</th>
<td>27.447</td>
<td>5.538</td>
<td>18.332</td>
<td>37.794</td>
<td>0.196</td>
<td>0.146</td>
<td>1050.0</td>
<td>761.0</td>
<td>1.00</td>
</tr>
<tr>
<th>sigma[3]</th>
<td>83.552</td>
<td>16.075</td>
<td>54.561</td>
<td>111.829</td>
<td>0.480</td>
<td>0.340</td>
<td>794.0</td>
<td>1345.0</td>
<td>1.01</td>
</tr>
<tr>
<th>sigma[4]</th>
<td>60.412</td>
<td>19.803</td>
<td>29.284</td>
<td>93.902</td>
<td>1.080</td>
<td>0.765</td>
<td>375.0</td>
<td>1595.0</td>
<td>1.01</td>
</tr>
<tr>
<th>sigma[5]</th>
<td>23.581</td>
<td>9.324</td>
<td>9.895</td>
<td>40.715</td>
<td>0.301</td>
<td>0.229</td>
<td>1089.0</td>
<td>932.0</td>
<td>1.01</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
<section id="figure-4-27">
<h3>Figure 4.27<a class="headerlink" href="#figure-4-27" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slope</span> <span class="o">=</span> <span class="n">mcmc_samples_centered</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">mcmc_samples_centered</span><span class="o">.</span><span class="n">beta_sigma</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">divergences</span> <span class="o">=</span> <span class="n">sampler_stats_centered</span><span class="p">[</span><span class="s1">'diverging'</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">axes</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">({</span><span class="s2">"β[4]"</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span> <span class="s2">"β_σ_hyperprior"</span><span class="p">:</span> <span class="n">sigma</span><span class="p">},</span>
                     <span class="n">joint_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"alpha"</span><span class="p">:</span> <span class="mf">.05</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">slope</span><span class="p">[</span><span class="n">divergences</span><span class="p">],</span> <span class="n">sigma</span><span class="p">[</span><span class="n">divergences</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'divergent sample'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/Neals_Funnel_Salad_Centered.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/plots/jointplot.py:144: UserWarning: plot_joint will be deprecated. Please use plot_pair instead.
  warnings.warn("plot_joint will be deprecated. Please use plot_pair instead.")
</pre></div>
</div>
<img alt="../_images/21a60684cdbf5edaaa0ba530d4db6b43d16ce758eca19e3f330a66b12af88104.png" src="../_images/21a60684cdbf5edaaa0ba530d4db6b43d16ce758eca19e3f330a66b12af88104.png"/>
</div>
</div>
</section>
<section id="code-4-16">
<h3>Code 4.16<a class="headerlink" href="#code-4-16" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">non_centered_beta_prior_fn</span><span class="p">(</span><span class="n">hyper_mu</span><span class="p">,</span> <span class="n">hyper_sigma</span><span class="p">):</span>
    <span class="n">β_offset</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"beta_offset"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">β_offset</span> <span class="o">*</span> <span class="n">hyper_sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">hyper_mu</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

<span class="c1"># hierarchical_salad_df is the generated dataset as pandas.DataFrame</span>
<span class="n">non_centered_model</span><span class="p">,</span> <span class="n">observed</span> <span class="o">=</span> <span class="n">gen_hierarchical_salad_sales</span><span class="p">(</span>
    <span class="n">hierarchical_salad_df</span><span class="p">,</span> <span class="n">non_centered_beta_prior_fn</span><span class="p">)</span>

<span class="n">mcmc_samples_noncentered</span><span class="p">,</span> <span class="n">sampler_stats_noncentered</span> <span class="o">=</span> <span class="n">run_mcmc</span><span class="p">(</span>
    <span class="mi">1000</span><span class="p">,</span> <span class="n">non_centered_model</span><span class="p">,</span> <span class="n">n_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_adaptation_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">sales</span><span class="o">=</span><span class="n">observed</span><span class="p">)</span>

<span class="n">divergent_per_chain</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sum.html#numpy.sum" title="numpy.sum"><span class="n">np</span><span class="o">.</span><span class="n">sum</span></a><span class="p">(</span><span class="n">sampler_stats_noncentered</span><span class="p">[</span><span class="s1">'diverging'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"""There were </span><span class="si">{</span><span class="n">divergent_per_chain</span><span class="si">}</span><span class="s2"> divergences after tuning per chain."""</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-11-19 16:50:17.643939: W tensorflow/compiler/tf2xla/kernels/assert_op.cc:38] Ignoring Assert operator mcmc_retry_init/assert_equal_1/Assert/AssertGuard/Assert
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There were [ 0  0 20  0] divergences after tuning per chain.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idata_non_centered_model</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.from_dict.html#arviz.from_dict" title="arviz.from_dict"><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span></a><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="p">{</span>
        <span class="n">k</span><span class="p">:</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.swapaxes.html#numpy.swapaxes" title="numpy.swapaxes"><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span></a><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mcmc_samples_noncentered</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="n">sample_stats</span><span class="o">=</span><span class="p">{</span>
        <span class="n">k</span><span class="p">:</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.swapaxes.html#numpy.swapaxes" title="numpy.swapaxes"><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span></a><span class="p">(</span><span class="n">sampler_stats_noncentered</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"target_log_prob"</span><span class="p">,</span> <span class="s2">"diverging"</span><span class="p">,</span> <span class="s2">"accept_ratio"</span><span class="p">,</span> <span class="s2">"n_steps"</span><span class="p">]}</span>
<span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_trace.html#arviz.plot_trace" title="arviz.plot_trace"><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span></a><span class="p">(</span><span class="n">idata_non_centered_model</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1d54620806c2ff428fb7fde0cce0a0b88593638d086310440dba78553a2be8cb.png" src="../_images/1d54620806c2ff428fb7fde0cce0a0b88593638d086310440dba78553a2be8cb.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.summary.html#arviz.summary" title="arviz.summary"><span class="n">az</span><span class="o">.</span><span class="n">summary</span></a><span class="p">(</span><span class="n">idata_non_centered_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr>
<th>beta_mu</th>
<td>5.050</td>
<td>0.073</td>
<td>4.914</td>
<td>5.188</td>
<td>0.002</td>
<td>0.001</td>
<td>2006.0</td>
<td>2092.0</td>
<td>1.0</td>
</tr>
<tr>
<th>beta_sigma</th>
<td>0.069</td>
<td>0.054</td>
<td>0.000</td>
<td>0.163</td>
<td>0.001</td>
<td>0.001</td>
<td>1384.0</td>
<td>1262.0</td>
<td>1.0</td>
</tr>
<tr>
<th>beta_offset[0]</th>
<td>-0.366</td>
<td>0.996</td>
<td>-2.141</td>
<td>1.592</td>
<td>0.018</td>
<td>0.015</td>
<td>3061.0</td>
<td>2485.0</td>
<td>1.0</td>
</tr>
<tr>
<th>beta_offset[1]</th>
<td>-0.096</td>
<td>0.885</td>
<td>-1.761</td>
<td>1.557</td>
<td>0.018</td>
<td>0.014</td>
<td>2556.0</td>
<td>2648.0</td>
<td>1.0</td>
</tr>
<tr>
<th>beta_offset[2]</th>
<td>0.392</td>
<td>0.890</td>
<td>-1.339</td>
<td>2.047</td>
<td>0.018</td>
<td>0.013</td>
<td>2457.0</td>
<td>2927.0</td>
<td>1.0</td>
</tr>
<tr>
<th>beta_offset[3]</th>
<td>0.040</td>
<td>0.972</td>
<td>-1.685</td>
<td>1.930</td>
<td>0.017</td>
<td>0.016</td>
<td>3099.0</td>
<td>2785.0</td>
<td>1.0</td>
</tr>
<tr>
<th>beta_offset[4]</th>
<td>0.230</td>
<td>1.038</td>
<td>-1.738</td>
<td>2.169</td>
<td>0.019</td>
<td>0.017</td>
<td>2940.0</td>
<td>2233.0</td>
<td>1.0</td>
</tr>
<tr>
<th>beta_offset[5]</th>
<td>-0.154</td>
<td>0.872</td>
<td>-1.794</td>
<td>1.466</td>
<td>0.017</td>
<td>0.013</td>
<td>2508.0</td>
<td>2880.0</td>
<td>1.0</td>
</tr>
<tr>
<th>sigma_prior</th>
<td>50.026</td>
<td>12.585</td>
<td>28.433</td>
<td>72.742</td>
<td>0.320</td>
<td>0.242</td>
<td>1842.0</td>
<td>1525.0</td>
<td>1.0</td>
</tr>
<tr>
<th>sigma[0]</th>
<td>60.975</td>
<td>16.688</td>
<td>33.831</td>
<td>93.832</td>
<td>0.400</td>
<td>0.307</td>
<td>2291.0</td>
<td>1523.0</td>
<td>1.0</td>
</tr>
<tr>
<th>sigma[1]</th>
<td>18.473</td>
<td>11.477</td>
<td>6.049</td>
<td>37.322</td>
<td>0.511</td>
<td>0.402</td>
<td>1086.0</td>
<td>601.0</td>
<td>1.0</td>
</tr>
<tr>
<th>sigma[2]</th>
<td>27.445</td>
<td>5.453</td>
<td>18.557</td>
<td>38.042</td>
<td>0.114</td>
<td>0.086</td>
<td>2785.0</td>
<td>1787.0</td>
<td>1.0</td>
</tr>
<tr>
<th>sigma[3]</th>
<td>83.830</td>
<td>17.153</td>
<td>55.301</td>
<td>114.967</td>
<td>0.418</td>
<td>0.330</td>
<td>2335.0</td>
<td>1584.0</td>
<td>1.0</td>
</tr>
<tr>
<th>sigma[4]</th>
<td>60.699</td>
<td>20.419</td>
<td>29.070</td>
<td>98.661</td>
<td>0.470</td>
<td>0.369</td>
<td>2558.0</td>
<td>1826.0</td>
<td>1.0</td>
</tr>
<tr>
<th>sigma[5]</th>
<td>24.146</td>
<td>10.760</td>
<td>10.322</td>
<td>42.645</td>
<td>0.400</td>
<td>0.322</td>
<td>1400.0</td>
<td>821.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
</section>
<section id="figure-4-28">
<h3>Figure  4.28<a class="headerlink" href="#figure-4-28" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">noncentered_beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">mcmc_samples_noncentered</span><span class="o">.</span><span class="n">beta_mu</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">mcmc_samples_noncentered</span><span class="o">.</span><span class="n">beta_offset</span> <span class="o">*</span> <span class="n">mcmc_samples_noncentered</span><span class="o">.</span><span class="n">beta_sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">slope</span> <span class="o">=</span> <span class="n">noncentered_beta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">mcmc_samples_noncentered</span><span class="o">.</span><span class="n">beta_sigma</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">divergences</span> <span class="o">=</span> <span class="n">sampler_stats_noncentered</span><span class="p">[</span><span class="s1">'diverging'</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">axes</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">({</span><span class="s2">"β[4]"</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span> <span class="s2">"β_σ_hyperprior"</span><span class="p">:</span> <span class="n">sigma</span><span class="p">},</span>
                     <span class="n">joint_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"alpha"</span><span class="p">:</span> <span class="mf">.05</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">slope</span><span class="p">[</span><span class="n">divergences</span><span class="p">],</span> <span class="n">sigma</span><span class="p">[</span><span class="n">divergences</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">"C4"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'divergent sample'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/Neals_Funnel_Salad_NonCentered.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/plots/jointplot.py:144: UserWarning: plot_joint will be deprecated. Please use plot_pair instead.
  warnings.warn("plot_joint will be deprecated. Please use plot_pair instead.")
</pre></div>
</div>
<img alt="../_images/496b43dcdd854ab958a3e567aa1b428bd3e914fbd0848723e68f3b7140641905.png" src="../_images/496b43dcdd854ab958a3e567aa1b428bd3e914fbd0848723e68f3b7140641905.png"/>
</div>
</div>
</section>
<section id="figure-4-29">
<h3>Figure 4.29<a class="headerlink" href="#figure-4-29" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">centered_β_sigma</span> <span class="o">=</span> <span class="n">mcmc_samples_centered</span><span class="o">.</span><span class="n">beta_sigma</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">noncentered_β_sigma</span> <span class="o">=</span> <span class="n">mcmc_samples_noncentered</span><span class="o">.</span><span class="n">beta_sigma</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_kde.html#arviz.plot_kde" title="arviz.plot_kde"><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span></a><span class="p">(</span><span class="n">centered_β_sigma</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Centered β_σ_hyperprior"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_kde.html#arviz.plot_kde" title="arviz.plot_kde"><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span></a><span class="p">(</span><span class="n">noncentered_β_sigma</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Noncentered β_σ_hyperprior"</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"color"</span><span class="p">:</span><span class="s2">"C4"</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Comparison of Centered vs Non Centered Estimates"</span><span class="p">);</span>
<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/Salad_Sales_Hierarchical_Comparison.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/32c68a15b653bcdd9100cd88283c31ec43813b6655b3d42a6d38e3f6058205dd.png" src="../_images/32c68a15b653bcdd9100cd88283c31ec43813b6655b3d42a6d38e3f6058205dd.png"/>
</div>
</div>
</section>
<section id="code-4-17">
<h3>Code 4.17<a class="headerlink" href="#code-4-17" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out_of_sample_customers</span> <span class="o">=</span> <span class="mf">50.</span>

<span class="nd">@tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span>
<span class="k">def</span> <span class="nf">out_of_sample_prediction_model</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">root</span><span class="p">(</span><span class="n">non_centered_model</span><span class="p">)</span>
    <span class="n">β</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">beta_offset</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">beta_sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">beta_mu</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    
    <span class="n">β_group</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">beta_mu</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">beta_sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"group_beta_prediction"</span><span class="p">)</span>
    <span class="n">group_level_prediction</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
        <span class="n">β_group</span> <span class="o">*</span> <span class="n">out_of_sample_customers</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">sigma_prior</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"group_level_prediction"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">β</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_of_sample_customers</span><span class="p">,</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">"location_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">_prediction"</span><span class="p">)</span>

<span class="n">amended_posterior</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span>
    <span class="n">non_centered_model</span><span class="o">.</span><span class="n">sample</span><span class="p">(),</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">mcmc_samples_noncentered</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">observed</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">ppc</span> <span class="o">=</span> <span class="n">out_of_sample_prediction_model</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">var0</span><span class="o">=</span><span class="n">amended_posterior</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">()</span>

<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_kde.html#arviz.plot_kde" title="arviz.plot_kde"><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span></a><span class="p">(</span><span class="n">ppc</span><span class="o">.</span><span class="n">group_level_prediction</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"color"</span><span class="p">:</span><span class="s2">"C0"</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"All locations"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_kde.html#arviz.plot_kde" title="arviz.plot_kde"><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span></a><span class="p">(</span><span class="n">ppc</span><span class="o">.</span><span class="n">location_2_prediction</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"color"</span><span class="p">:</span><span class="s2">"C2"</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Location 2"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_kde.html#arviz.plot_kde" title="arviz.plot_kde"><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span></a><span class="p">(</span><span class="n">ppc</span><span class="o">.</span><span class="n">location_4_prediction</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"color"</span><span class="p">:</span><span class="s2">"C4"</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Location 4"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Predicted revenue with 50 customers"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">600</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<a class="sphinx-codeautolink-a" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig" title="matplotlib.pyplot.savefig"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span></a><span class="p">(</span><span class="s2">"img/chp04/Salad_Sales_Hierarchical_Predictions.png"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c6c9ec26da63caef4a2366e1125668cdd82ad528e3cd8510fc541af511fa2d8c.png" src="../_images/c6c9ec26da63caef4a2366e1125668cdd82ad528e3cd8510fc541af511fa2d8c.png"/>
</div>
</div>
</section>
<section id="code-4-18">
<h3>Code 4.18<a class="headerlink" href="#code-4-18" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out_of_sample_customers2</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.arange.html#numpy.arange" title="numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

<span class="nd">@tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span>
<span class="k">def</span> <span class="nf">out_of_sample_prediction_model2</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">root</span><span class="p">(</span><span class="n">non_centered_model</span><span class="p">)</span>
    
    <span class="n">β_new_loc</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">beta_mu</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">beta_sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"beta_new_loc"</span><span class="p">)</span>
    <span class="n">σ_new_loc</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sigma_prior</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"sigma_new_loc"</span><span class="p">)</span>
    <span class="n">group_level_prediction</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
        <span class="n">β_new_loc</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">out_of_sample_customers2</span><span class="p">,</span>
        <span class="n">σ_new_loc</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"new_location_prediction"</span><span class="p">)</span>

<span class="n">ppc</span> <span class="o">=</span> <span class="n">out_of_sample_prediction_model2</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">var0</span><span class="o">=</span><span class="n">amended_posterior</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://python.arviz.org/en/stable/api/generated/arviz.plot_hdi.html#arviz.plot_hdi" title="arviz.plot_hdi"><span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span></a><span class="p">(</span><span class="n">out_of_sample_customers2</span><span class="p">,</span> <span class="n">ppc</span><span class="o">.</span><span class="n">new_location_prediction</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">.95</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/miniconda3/envs/bmcp/lib/python3.9/site-packages/arviz/data/base.py:169: UserWarning: More chains (1000) than draws (4). Passed array should have shape (chains, draws, *shape)
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/3425a4507498b403c98c18c87517f0e4895464afd91745a08dc23d8bbf54d4cf.png" src="../_images/3425a4507498b403c98c18c87517f0e4895464afd91745a08dc23d8bbf54d4cf.png"/>
</div>
</div>
</section>
</section>
</section>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
</article>
<footer class="prev-next-footer">
<div class="prev-next-area">
<a class="left-prev" href="chp_03.html" title="previous page">
<i class="fa-solid fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Code 3: Linear Models and Probabilistic Programming Languages</p>
</div>
</a>
<a class="right-next" href="chp_05.html" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Code 5: Splines</p>
</div>
<i class="fa-solid fa-angle-right"></i>
</a>
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">
<div class="sidebar-secondary-item">
<div class="page-toc tocsection onthispage">
<i class="fa-solid fa-list"></i> Contents
  </div>
<nav class="bd-toc-nav page-toc">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transforming-covariates">Transforming Covariates</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-1">Code 4.1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-1">Figure 4.1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-2">Code 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-2">Figure 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-3">Code 4.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-3">Figure 4.3</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#varying-uncertainty">Varying Uncertainty</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-4">Code 4.4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-4">Figure 4.4</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interaction-effects">Interaction effects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-5">Code 4.5</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-6">Code 4.6</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-5">Figure 4.5</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#robust-regression">Robust Regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-6">Figure 4.6</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-7">Figure 4.7</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-7">Code 4.7</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-8">Figure 4.8</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-1">Table 4.1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-2">Table 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-9">Figure 4.9</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-multilevel-models-and-mixed-effects">Pooling, Multilevel Models, and Mixed Effects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-10">Figure 4.10</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unpooled-model">Unpooled Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-9">Code 4.9</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-12">Figure 4.12</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-13">Figure 4.13</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-14">Figure 4.14</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooled-model">Pooled Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-10">Code 4.10</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-16">Figure 4.16</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-17">Figure 4.17</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-18">Figure 4.18</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-11">Code 4.11</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-20">Figure 4.20</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-21">Figure 4.21</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hierarchical">Hierarchical</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-12">Code 4.12</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-23">Figure 4.23</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-3">Table 4.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-4-4">Table 4.4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-25">Figure 4.25</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-26">Figure 4.26</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-13">Code 4.13</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-14-and-4-15">Code 4.14 and 4.15</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-27">Figure 4.27</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-16">Code 4.16</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-28">Figure  4.28</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4-29">Figure 4.29</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-17">Code 4.17</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-4-18">Code 4.18</a></li>
</ul>
</li>
</ul>
</nav></div>
</div></div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner container">
<div class="footer-item">
<p class="component-author">
By Martin, Kumar, Lao
</p>
</div>
<div class="footer-item">
<p class="copyright">
    
      © Copyright 2022.
      <br/>
</p>
</div>
<div class="footer-item">
</div>
<div class="footer-item">
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>
<footer class="bd-footer">
</footer>
</body>
</html>